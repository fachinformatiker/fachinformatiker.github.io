<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Untitled - fachinformatiker.app</title><meta name="description" content="Last time we covered a very basic setup. Multiple people have contacted me so far requesting an explanation on how to move towards a slightly more sophisticated authentication setup. Usually involving a php script to authenticate against. Maybe you want to use an existing mySQL or mariaDB database to set up users and channels? Fear not, this is not that complicated to start out with.Server side configurationStarting from this example, we set up a basic rtmp section:rtmp {  server {    listen 1935;	ping 30s;	notify_method get;	  	application stream {	  live on;	  on_publish http://yourdomain.com/rtmp_auth.php;	  record off;	}  }}"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://fachinformatiker.github.io/fachinformatiker.github.io/object-object.html"><link rel="alternate" type="application/atom+xml" href="https://fachinformatiker.github.io/fachinformatiker.github.io/feed.xml"><link rel="alternate" type="application/json" href="https://fachinformatiker.github.io/fachinformatiker.github.io/feed.json"><meta property="og:title" content="Untitled"><meta property="og:site_name" content="fachinformatiker.app"><meta property="og:description" content="Last time we covered a very basic setup. Multiple people have contacted me so far requesting an explanation on how to move towards a slightly more sophisticated authentication setup. Usually involving a php script to authenticate against. Maybe you want to use an existing mySQL or mariaDB database to set up users and channels? Fear not, this is not that complicated to start out with.Server side configurationStarting from this example, we set up a basic rtmp section:rtmp {  server {    listen 1935;	ping 30s;	notify_method get;	  	application stream {	  live on;	  on_publish http://yourdomain.com/rtmp_auth.php;	  record off;	}  }}"><meta property="og:url" content="https://fachinformatiker.github.io/fachinformatiker.github.io/object-object.html"><meta property="og:type" content="article"><link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin><style>h1,h2,h3,h4,h5,h6,.btn,[type=button],[type=submit],button,.navbar .navbar__menu li,.navbar_mobile_sidebar .navbar__menu li,.feed__author,.post__tag,.post__share>a span,.post__nav-link>span,.footer{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol"}body,h1,.h1,blockquote,.search__input,.author__name,.author__info>p,.feed__item h2,.post__nav-link{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol"}</style><link rel="stylesheet" href="https://fachinformatiker.github.io/fachinformatiker.github.io/assets/css/style.css?v=cc87cb8806c844f0646558fe70d5c5d1"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://fachinformatiker.github.io/fachinformatiker.github.io/object-object.html"},"headline":"Untitled","datePublished":"2019-07-11T20:55","dateModified":"2020-05-12T08:43","description":"<p>Last time we covered a very basic setup. Multiple people have contacted me so far requesting an explanation on how to move towards a slightly more sophisticated authentication setup. Usually involving a php script to authenticate against. Maybe you want to use an existing mySQL or mariaDB database to set up users and channels? Fear not, this is not that complicated to start out with.</p>\n<h1 id=\"server-side-configuration\">Server side configuration</h1>\n<p>Starting from this example, we set up a basic rtmp section:</p>\n<div class=\"highlight\">\n<pre><code class=\"language-nginx\" data-lang=\"nginx\">rtmp {\n  server {\n    listen 1935;\n\tping 30s;\n\tnotify_method get;\n\t  \n\tapplication stream {\n\t  live on;\n\t  on_publish http://yourdomain.com/rtmp_auth.php;\n\t  record off;\n\t}\n  }\n}</code></pre>\n</div>\n","author":{"@type":"Person","name":"Patrick Szalewicz"},"publisher":{"@type":"Organization","name":"Patrick Szalewicz"}}</script><script src="https://fachinformatiker.github.io/fachinformatiker.github.io/assets/js/ls.parent-fit.min.js?v=f8467455ea5c88e3e51a4f212d2632bd"></script><script async src="https://fachinformatiker.github.io/fachinformatiker.github.io/assets/js/lazysizes.min.js?v=6a69d476c93de2b78a72acb259abccea"></script></head><body><div class="site-container"><header class="top" id="js-header"><a class="logo" href="https://fachinformatiker.github.io/fachinformatiker.github.io/">fachinformatiker.app</a><div class="search"><div class="search__overlay js-search-overlay"><div class="search__overlay-inner"><form action="https://fachinformatiker.github.io/fachinformatiker.github.io/search.html" class="search__form"><input class="search__input js-search-input" type="search" name="q" placeholder="search..." autofocus="autofocus"></form><button class="search__close js-search-close" aria-label="Close">Close</button></div></div><button class="search__btn js-search-btn" aria-label="Search"><svg role="presentation" focusable="false"><use xlink:href="https://fachinformatiker.github.io/fachinformatiker.github.io/assets/svg/svg-map.svg#search"/></svg></button></div></header><main><article class="post"><div class="hero"><header class="hero__content"><div class="wrapper"><div class="post__meta"><time datetime="2019-07-11T20:55">July 11, 2019</time></div><h1>Untitled</h1><div class="post__meta post__meta--author"><a href="https://fachinformatiker.github.io/fachinformatiker.github.io/authors/patrick-szalewicz/" class="feed__author invert">Patrick Szalewicz</a></div></div></header></div><div class="wrapper post__entry"><p>Last time we covered a very basic setup. Multiple people have contacted me so far requesting an explanation on how to move towards a slightly more sophisticated authentication setup. Usually involving a php script to authenticate against. Maybe you want to use an existing mySQL or mariaDB database to set up users and channels? Fear not, this is not that complicated to start out with.</p><h1 id="server-side-configuration">Server side configuration</h1><p>Starting from this example, we set up a basic rtmp section:</p><div class="highlight"><pre><code class="language-nginx" data-lang="nginx">rtmp {
  server {
    listen 1935;
	ping 30s;
	notify_method get;
	  
	application stream {
	  live on;
	  on_publish http://yourdomain.com/rtmp_auth.php;
	  record off;
	}
  }
}</code></pre></div><p>The <code>on_publish</code> command can point to any web address that you like. It could be supplied via the nginx server as well or you could use an apache2 instance for that. You can also use a completely different server if you wish. For now, we assume that there is a php script rtmp_auth.php which sits in the webroot of your webserver.</p><p>The above line will do the following:</p><ul><li>as soon as someone tries to publish a stream to your domain, the nginx rtmp module will issue a HTTP POST request to the <code>on_publish</code> url.</li><li>nginx will supply the script with the get variable “name” and fill it with whatever comes directly after your initial stream url</li><li>it will also pass on any further GET style variables via the standard <code>?var1=value1&amp;var2=value2</code> syntax.</li><li>it will wait for a HTTP return code which either tells it that everything is fine and streaming should commence (201) or that something went wront and it should drop the connection (404)</li></ul><p>Suppose someone uses the following url to connect to your rtmp server:</p><p><code>rtmp://yourdomain.com/stream/john?psk=supersecret</code></p><p>nginx will then call your rtmp_auth.php script like this:</p><p><code>http://yourdomain.com/rtmp_auth.php?name=john&amp;psk=supersecret</code></p><p>Inside of your php script you then have access to the $_POST array which holds your values and you can do whatever you want with them. In the following example we will use a php array <code>$valid_users</code> to hold a list of allowed users and passwords. Of course, you could instead connect to a database and query for the username and password. The interesting part is all in the if-statement which follows after that.</p><div class="highlight"><pre><code class="language-php" data-lang="php">&lt;?php
$username = $_POST["name"]; # in our current example, this will be 'john'
$password = $_POST["psk"]; # in our current example, this will be 'supersecret'

$valid_users = array("john" =&gt; "supersecret",
                     "winnie" =&gt; "thepooh",
					 "batman" =&gt; "nananananananana");

if ($valid_users[$username] == $password) {
  http_response_code(201); # return 201 "Created"
} else {
  http_response_code(404); # return 404 "Not Found"
}
?&gt;
</code></pre></div><p>With this code, if the credentials check out, we return a 201 status code which tells nginx that whoever tries to connect is allowed to stream. If they do not, we issue a 404 and tell the client to get lost.</p><h1 id="client-side-configuration">Client side configuration</h1><p>Let us suppose your streaming client uses open broadcaster studio (OBS), which is a free and open source streaming utility which works with pretty much all major streaming sites and can also be configured to a custom site.</p><p>In OBS, you set the stream type to <strong>Custom Streaming Server</strong> and as the url you would use <code>rtmp://yourdomain.com/stream/</code>. As the stream key you would set <code>john?psk=supersecret</code> or any other username / password combination. If you want to supply more information you can supply more GET style variables via appending <code>&amp;var1=value1&amp;var2=value2</code> and so on. Anything you write before the <code>?</code> in the stream key field will end up in the variable <code>$_POST["name"]</code> inside your php script.</p><p>Sadly, SSL support for RTMP and also for the internal <code>on_publish</code>request is still somewhat lacking. So keep in mind that all of this stuff is plaintext authentication. You might not want to use a username / password combo directly but rather a streaming hash that you can allocate via a database and which has to be requested by the user beforehand. At least this way, if someone captures the data, they do not know the login credentials of your users.</p><p>You could for example generate a 64 character hash, put it into an SQL table and assign it to a user of your site. Then the user just enters this hash in OBS into the stream key field. Your php script will then be called and the variable <code>$_POST["name"]</code> will hold this hash. After that you can connect to your database, check out whether the hash exists or not and maybe even set up some notification on your website that user <strong>john</strong> is now streaming. Just be sure to finish with a 201 or 404 code in order to let nginx-rtmp know what it should do about the connection attempt.</p><p>In the end you can make things as complex as you want. You can use the same method for other nginx-rtmp directives such as: <code>on_play, on_done, on_update</code> and many more. Check them out at the <a href="https://github.com/arut/nginx-rtmp-module/wiki/Directives" target="_blank" rel="noopener noreferrer">nginx-rtmp wiki page</a>.</p><p><strong>Update:</strong> A kind reader has informed me that newer versions of the nginx rtmp plugin no longer use a GET but a POST request to call the URL you specify in the on_publish, on_play, etc directives. I have updated the code to reflect the changes.</p></div><footer class="wrapper post__footer"><p class="post__last-updated">This article was updated on May 12, 2020</p><ul class="post__tag"><li><a href="https://fachinformatiker.github.io/fachinformatiker.github.io/homelab/">Homelab</a></li><li><a href="https://fachinformatiker.github.io/fachinformatiker.github.io/linux/">Linux</a></li><li><a href="https://fachinformatiker.github.io/fachinformatiker.github.io/projects/">Projects</a></li><li><a href="https://fachinformatiker.github.io/fachinformatiker.github.io/raspberry-pi/">Raspberry Pi</a></li><li><a href="https://fachinformatiker.github.io/fachinformatiker.github.io/server/">Server</a></li><li><a href="https://fachinformatiker.github.io/fachinformatiker.github.io/tutorials/">Tutorials</a></li></ul><div class="post__share"></div><div class="post__bio bio"><div class="bio__info"><h3 class="bio__name"><a href="https://fachinformatiker.github.io/fachinformatiker.github.io/authors/patrick-szalewicz/" class="invert" rel="author">Patrick Szalewicz</a></h3></div></div></footer></article><nav class="post__nav"><div class="post__nav-inner"><div class="post__nav-prev"><svg width="1.041em" height="0.416em" aria-hidden="true"><use xlink:href="https://fachinformatiker.github.io/fachinformatiker.github.io/assets/svg/svg-map.svg#arrow-prev"/></svg> <a href="https://fachinformatiker.github.io/fachinformatiker.github.io/how-to-set-up-your-own-private-rtmp-server-using-nginx.html" class="invert post__nav-link" rel="prev"><span>Previous</span> How to set up your own private RTMP server using nginx</a></div><div class="post__nav-next"><a href="https://fachinformatiker.github.io/fachinformatiker.github.io/setting-up-a-caching-only-dns-server.html" class="invert post__nav-link" rel="next"><span>Next</span> Setting up a Caching-Only DNS Server </a><svg width="1.041em" height="0.416em" aria-hidden="true"><use xlink:href="https://fachinformatiker.github.io/fachinformatiker.github.io/assets/svg/svg-map.svg#arrow-next"/></svg></div></div></nav></main><footer class="footer"><div class="footer__copyright">Powered by <a href="https://getpublii.com" target="_blank" rel="nofollow noopener">Publii Static CMS</a></div><button class="footer__bttop js-footer__bttop" aria-label="Back to top"><svg><title>Back to top</title><use xlink:href="https://fachinformatiker.github.io/fachinformatiker.github.io/assets/svg/svg-map.svg#toparrow"/></svg></button></footer></div><script>window.publiiThemeMenuConfig = {    
        mobileMenuMode: 'sidebar',
        animationSpeed: 300,
        submenuWidth: 'auto',
        doubleClickTime: 500,
        mobileMenuExpandableSubmenus: true, 
        relatedContainerForOverlayMenuSelector: '.top',
   };</script><script defer="defer" src="https://fachinformatiker.github.io/fachinformatiker.github.io/assets/js/scripts.min.js?v=205f40927e4a45297a0b266e50ad78d5"></script><script>var lazyFeaturedImage=function lazyFeaturedImage(){var b=document.querySelectorAll(".hero__image-img");for(var a=0;a<b.length;a++){var c=b[a];c.addEventListener("lazyloaded",function(f){var d=f.target.parentNode;d.classList.add("hero__image--overlay")})}};lazyFeaturedImage();</script></body></html>